<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lab Test Report</title>
  <style>
    body { font-family: Arial, sans-serif; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #dddddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .company-details { display: flex; gap: 20px; margin-bottom: 20px; }
    .logo-column { border-right: 2px solid #ddd; padding-right: 20px; }
    .details-column { padding-left: 20px; }
    .logo { width: 100px; height: auto; }
    .header { display: flex; justify-content: space-between; padding: 10px; background: #e6edf7; border: 1px solid #ddd; margin-bottom: 20px; }
    .header .column { flex: 1; padding: 0 10px; }
    .header .column:not(:last-child) { border-right: 2px solid #ddd; }
    .report-footer { column-count: 2; column-gap: 20px; font-size: 12px; margin-top: 30px; }
    .footer { text-align: center; margin-top: 40px; font-size: 12px; font-style: italic; color: gray; font-weight: bold; }
    .flag-low { color: #d8a500; }
    .flag-high { color: #d30d0d; }
    .flag-normal { color: #0d7d2a; }
    .interpretation-section { margin-top: 30px; padding: 15px; background: #f9f9f9; border-left: 4px solid #2196f3; }
    .interpretation-title { font-weight: bold; color: #2196f3; margin-bottom: 10px; font-size: 16px; }
    .interpretation-item { margin-bottom: 15px; padding: 10px; background: #fff; border-radius: 4px; border: 1px solid #e0e0e0; }
    .interpretation-item.critical { border-left: 4px solid #d32f2f; background: #ffebee; }
    .attention-flag { display: inline-block; background: #d32f2f; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; margin-left: 10px; }
  </style>
</head>
<body>
  <div class="company-details">
    <div class="logo-column">
      {% if company_logo_url %}
      <img src="{{ company_logo_url }}" class="logo" alt="Company Logo">
      {% endif %}
    </div>
    <div class="details-column">
      <p><strong>{{ company.name }}</strong></p>
      <p>Address: {{ company.address1 }}</p>
      <p>
        {{ company.phone1 }}
        {% if company.email1 %}
        | {{ company.email1 }}
        {% endif %}
      </p>
    </div>
  </div>

  <div class="report-title">
    <h2 style="text-align: center;">Laboratory Test Report</h2>
  </div>

  <div class="header">
    <div class="column">
      <p><strong>Patient Particulars</strong></p>
      <p>{{ patient.first_name }} {{ patient.second_name }}</p>
      <p>Gender: {{ patient.gender }} | Age: {{ patient.age }}</p>
      <p>Patient ID: {{ patient.id }}</p>
      <p>Ref: {{ processtestrequest.reference }}</p>
    </div>

    <div class="column">
      <p><strong>Request Details</strong></p>
      <p>
        <strong>Requested Date:</strong>
        {% if requested_date %}
        {{ requested_date|date:"d M Y" }}
        {% else %}
        N/A
        {% endif %}
      </p>
      <p>
        <strong>Requested Time:</strong>
        {% if requested_time %}
        {{ requested_time|time:"H:i" }}
        {% else %}
        N/A
        {% endif %}
      </p>
      <p>
        <strong>Results Entered:</strong>
        {% if result_entered_datetime %}
        {{ result_entered_datetime|date:"d M Y H:i" }}
        {% else %}
        Pending
        {% endif %}
      </p>
    </div>
  </div>

  {% if quantitative_panels %}
  <table>
    <thead>
      <tr>
        <th>Test Panel</th>
        <th>Result</th>
        <th>Flag</th>
        <th>Ref Value</th>
        <th>Unit</th>
      </tr>
    </thead>
    <tbody>
      {% for panel in quantitative_panels %}
      <tr>
        <td>{{ panel.test_panel_name }}</td>
        <td>{{ panel.result }}</td>
        <td>
          {% if panel.flag == "Low" %}
          <span class="flag-low">Low</span>
          {% elif panel.flag == "High" %}
          <span class="flag-high">High</span>
          {% else %}
          <span class="flag-normal">Normal</span>
          {% endif %}
        </td>
        <td>{{ panel.ref_value_low }} - {{ panel.ref_value_high }}</td>
        <td>{{ panel.unit }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  {% if qualitative_panels %}
  <table>
    <thead>
      <tr>
        <th>Test Panel</th>
        <th>Result</th>
      </tr>
    </thead>
    <tbody>
      {% for panel in qualitative_panels %}
      <tr>
        <td>{{ panel.test_panel_name }}</td>
        <td>{{ panel.result }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  {% if first_labtestrequest and first_labtestrequest.note %}
  <p><strong>Notes:</strong></p>
  <p>{{ first_labtestrequest.note }}</p>
  {% endif %}

  {% if quantitative_panels or qualitative_panels %}
  <div class="interpretation-section">
    <div class="interpretation-title">Clinical Interpretations</div>

    {% for panel in quantitative_panels %}
    {% if panel.interpretation %}
    <div class="interpretation-item {% if panel.requires_attention %}critical{% endif %}">
      <div class="interpretation-test-name">
        {{ panel.test_panel_name }} ({{ panel.result }} {{ panel.unit }})
        {% if panel.requires_attention %}
        <span class="attention-flag">⚠ URGENT</span>
        {% endif %}
      </div>
      <div class="interpretation-text">
        <strong>Interpretation:</strong> {{ panel.interpretation }}
      </div>
      {% if panel.clinical_action %}
      <div class="clinical-action">
        <strong>Recommended Action:</strong> {{ panel.clinical_action }}
      </div>
      {% endif %}
    </div>
    {% endif %}
    {% endfor %}

    {% for panel in qualitative_panels %}
    {% if panel.interpretation %}
    <div class="interpretation-item {% if panel.requires_attention %}critical{% endif %}">
      <div class="interpretation-test-name">
        {{ panel.test_panel_name }} ({{ panel.result }})
        {% if panel.requires_attention %}
        <span class="attention-flag">⚠ URGENT</span>
        {% endif %}
      </div>
      <div class="interpretation-text">
        <strong>Interpretation:</strong> {{ panel.interpretation }}
      </div>
      {% if panel.clinical_action %}
      <div class="clinical-action">
        <strong>Recommended Action:</strong> {{ panel.clinical_action }}
      </div>
      {% endif %}
    </div>
    {% endif %}
    {% endfor %}
  </div>
  {% endif %}

  <div class="report-footer">
    <p><strong>Date Posted:</strong> {{ approved_on }}</p>
    <p>
      <strong>Requested By:</strong>
      {% if attendance_process.doctor %}
      {{ attendance_process.doctor.first_name }}
      {% else %}
      N/A
      {% endif %}
    </p>
    <p>
      <strong>Done By:</strong>
      {% if attendance_process.lab_tech %}
      {{ attendance_process.lab_tech.first_name }}
      {% else %}
      _______________
      {% endif %}
    </p>
    <p><strong>Approved By:</strong> ____________________________</p>
    <p>
      <strong>Equipment:</strong>
      {% if first_labtestrequest %}
      {{ first_labtestrequest.equipment }}
      {% else %}
      _______________
      {% endif %}
    </p>
  </div>

  <section class="footer">
    <span>Generated by: EaSyMed-HMIS</span>
    <p>Email: admin@proto-typesolution.com</p>
  </section>
</body>
</html>
