<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lab Test Report</title>
  <style>
    @page {
      size: A4;
      margin: 1cm;
    }

    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-size: 10px;
      line-height: 1.4;
      color: #333;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #555;
      padding-bottom: 20px;
      margin-bottom: 30px;
      height: 150px;
    }

    .company-logo img {
      max-width: 180px;
      height: 100%;
    }

    .company-info {
      text-align: right;
      font-size: 11px;
    }

    .company-info h2 {
      margin: 0 0 5px 0;
      color: #555;
      font-size: 18px;
      text-transform: uppercase;
    }

    .company-info p {
      margin: 2px 0;
    }

    .report-title {
      text-align: center;
      margin-bottom: 30px;
    }

    .report-title h1 {
      font-size: 24px;
      color: #333;
      margin: 0;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .meta-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .meta-box {
      width: 48%;
    }

    .meta-box h3 {
      font-size: 12px;
      color: #555;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .meta-row {
      display: flex;
      margin-bottom: 4px;
    }

    .meta-label {
      font-weight: bold;
      width: 110px;
      color: #555;
    }

    .meta-value {
      flex: 1;
    }

    table.results-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    table.results-table th {
      background-color: #555;
      color: white;
      padding: 10px;
      text-align: left;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
    }

    table.results-table td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      color: #444;
    }

    table.results-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .flag-low {
      color: #d8a500;
      font-weight: bold;
    }

    .flag-high {
      color: #d30d0d;
      font-weight: bold;
    }

    .flag-normal {
      color: #0d7d2a;
    }

    .interpretation-section {
      margin-top: 30px;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #555;
      page-break-inside: avoid;
    }

    .interpretation-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      font-size: 14px;
      text-transform: uppercase;
    }

    .interpretation-item {
      margin-bottom: 15px;
      padding: 10px;
      background: #fff;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }

    .interpretation-item.critical {
      border-left: 4px solid #d32f2f;
      background: #ffebee;
    }

    .attention-flag {
      display: inline-block;
      background: #d32f2f;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: bold;
      margin-left: 10px;
    }

    .signatures {
      display: flex;
      justify-content: space-between;
      margin-top: 60px;
      page-break-inside: avoid;
      clear: both;
    }

    .signature-box {
      width: 30%;
      text-align: left;
    }

    .signature-header {
      font-weight: bold;
      font-size: 11px;
      color: #555;
      text-transform: uppercase;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }

    .signature-row {
      display: flex;
      align-items: baseline;
      margin-bottom: 15px;
      position: relative;
    }

    .signature-row {
      margin-top: 15px;
      position: relative;
      width: 100%;
      min-height: 25px;
    }

    .sig-label {
      font-size: 10px;
      font-weight: bold;
      color: #555;
      width: 45px;
      display: inline-block;
      vertical-align: bottom;
      padding-bottom: 2px;
    }

    .sig-value {
      display: inline-block;
      vertical-align: bottom;
      border-bottom: 1px solid #aaa;
      width: calc(100% - 50px);
      min-height: 18px;
    }

    .sig-value-text {
      font-size: 11px;
      padding-left: 5px;
      padding-bottom: 2px;
    }

    .signature-image {
      position: absolute;
      bottom: 2px;
      left: 50px;
      height: 60px;
      z-index: 10;
    }

    .signature-image img {
      max-height: 100%;
      max-width: 150px;
      display: block;
    }

    @page {
      size: A4;
      margin: 1cm;
      margin-bottom: 2cm;

      @bottom-center {
        content: element(footer-content);
        width: 100%;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="company-details">
      <div class="logo-column">
        {% if company_logo_url %}
        <img src="{{ company_logo_url }}" class="logo" alt="Company Logo" />
        {% endif %}
      </div>
      <div class="details-column">
        <p><strong>{{ company.name }}</strong></p>
        <p>Address: {{ company.address1 }}</p>
        <p>
          {{ company.phone1 }} {% if company.email1 %} | {{ company.email1 }} {%
          endif %}
        </p>
      </div>
    </div>

  <div class="header-container">
    <div class="company-logo">
      <img src="{{ company_logo_url }}" alt="Logo" />
    </div>
    <div class="company-info">
      <h2>{{ company.name }}</h2>
      <p>{{ company.address1 }}</p>
      {% if company.address2 %}<p>{{ company.address2 }}</p>{% endif %}
      <p>{{ company.phone1 }} {% if company.phone2 %} | {{ company.phone2 }}{% endif %}</p>
      <p>{{ company.email1 }}</p>
    </div>
  </div>

  <div class="report-title">
    <h1>Laboratory Report</h1>
  </div>

  <div class="meta-container">
    <div class="meta-box">
      <h3>Patient Particulars</h3>
      <div class="meta-row">
        <span class="meta-label">Name:</span>
        <span class="meta-value">{{ patient.first_name }} {{ patient.second_name }}</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">ID:</span>
        <span class="meta-value">{{ patient.id }}</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">Age/Gender:</span>
        <span class="meta-value">{{ patient.age }} / {{ patient.gender }}</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">Ref:</span>
        <span class="meta-value">{{ processtestrequest.reference }}</span>
      </div>
    </div>

      <div class="column">
        <p><strong>Request Details</strong></p>
        <p>
          <strong>Requested Date:</strong>
          {% if requested_date %} {{ requested_date|date:"d M Y" }} {% else %}
          N/A {% endif %}
        </p>
        <p>
          <strong>Requested Time:</strong>
          {% if requested_time %} {{ requested_time|time:"H:i" }} {% else %} N/A
          {% endif %}
        </p>
        <p>
          <strong>Results Entered:</strong>
          {% if result_entered_datetime %} {{ result_entered_datetime|date:"d M
          Y H:i" }} {% else %} Pending {% endif %}
        </p>
      </div>
    </div>
  </div>

    {% if quantitative_panels %}
    <table>
      <thead>
        <tr>
          <th>Test Panel</th>
          <th>Result</th>
          <th>Flag</th>
          <th>Ref Value</th>
          <th>Unit</th>
        </tr>
      </thead>
      <tbody>
        {% for panel in quantitative_panels %}
        <tr>
          <td>{{ panel.test_panel_name }}</td>
          <td>{{ panel.result }}</td>
          <td>
            {% if panel.flag == "Low" %}
            <span class="flag-low">Low</span>
            {% elif panel.flag == "High" %}
            <span class="flag-high">High</span>
            {% else %}
            <span class="flag-normal">Normal</span>
            {% endif %}
          </td>
          <td>{{ panel.ref_value_low }} - {{ panel.ref_value_high }}</td>
          <td>{{ panel.unit }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %} {% if qualitative_panels %}
    <table>
      <thead>
        <tr>
          <th>Test Panel</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody>
        {% for panel in qualitative_panels %}
        <tr>
          <td>{{ panel.test_panel_name }}</td>
          <td>{{ panel.result }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %} {% if first_labtestrequest and first_labtestrequest.note %}
    <p><strong>Notes:</strong></p>
    <p>{{ first_labtestrequest.note }}</p>
    {% endif %} {% if quantitative_panels or qualitative_panels %}
    <div class="interpretation-section">
      <div class="interpretation-title">Clinical Interpretations</div>

      {% for panel in quantitative_panels %} {% if panel.interpretation %}
      <div
        class="interpretation-item {% if panel.requires_attention %}critical{% endif %}"
      >
        <div class="interpretation-test-name">
          {{ panel.test_panel_name }} ({{ panel.result }} {{ panel.unit }}) {%
          if panel.requires_attention %}
          <span class="attention-flag">⚠ URGENT</span>
          {% endif %}
        </div>
        <div class="interpretation-text">
          <strong>Interpretation:</strong> {{ panel.interpretation }}
        </div>
        {% if panel.clinical_action %}
        <div class="clinical-action">
          <strong>Recommended Action:</strong> {{ panel.clinical_action }}
        </div>
        {% endif %}
      </div>
      {% endif %} {% endfor %} {% for panel in qualitative_panels %} {% if
      panel.interpretation %}
      <div
        class="interpretation-item {% if panel.requires_attention %}critical{% endif %}"
      >
        <div class="interpretation-test-name">
          {{ panel.test_panel_name }} ({{ panel.result }}) {% if
          panel.requires_attention %}
          <span class="attention-flag">⚠ URGENT</span>
          {% endif %}
        </div>
        <div class="interpretation-text">
          <strong>Interpretation:</strong> {{ panel.interpretation }}
        </div>
        {% if panel.clinical_action %}
        <div class="clinical-action">
          <strong>Recommended Action:</strong> {{ panel.clinical_action }}
        </div>
        {% endif %}
      </div>
      {% endif %} {% endfor %}
    </div>
    {% endif %}
    {% endfor %}
  </div>
  {% endif %}

    <div class="report-footer">
      <p><strong>Date Posted:</strong> {{ approved_on }}</p>
      <p>
        <strong>Requested By:</strong>
        {% if attendance_process.doctor %} {{
        attendance_process.doctor.first_name }} {% else %} N/A {% endif %}
      </p>
      <p>
        <strong>Done By:</strong>
        {% if attendance_process.lab_tech %} {{
        attendance_process.lab_tech.first_name }} {% else %} _______________ {%
        endif %}
      </p>
      <p><strong>Approved By:</strong> ____________________________</p>
      <p>
        <strong>Equipment:</strong>
        {% if first_labtestrequest %} {{ first_labtestrequest.equipment }} {%
        else %} _______________ {% endif %}
      </p>
    </div>
  </div>

</body>

</html>