name: CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_TOKEN: ${{ secrets.DOCKER_PASSWORD }}
  DEMO_SERVER_PRIVATE_KEY: ${{ secrets.DEMO_SERVER_PRIVATE_KEY }}
  DEMO_SERVER_IP: ${{ secrets.DEMO_SERVER_IP }}
  DEMO_SERVER_USERNAME: ${{ secrets.DEMO_SERVER_USER }}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Docker system prune
        run: docker system prune -af
  test-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend test image
        run: |
          docker build -f backend/Dockerfile -t backend-test:ci ./backend

      - name: Run backend system checks & unit tests
        run: |
          docker run --rm \
            -e SECRET_KEY='django-insecure-test-key-for-ci-only' \
            -e DJANGO_SETTINGS_MODULE=easymed.settings.base \
            -e DEBUG=True \
            -e EMAIL_BACKEND='django.core.mail.backends.console.EmailBackend' \
            -e EMAIL_USE_TLS=True \
            -e EMAIL_HOST='localhost' \
            -e EMAIL_PORT=587 \
            -e EMAIL_HOST_USER='test@example.com' \
            -e EMAIL_HOST_PASSWORD='testpassword' \
            -e DEFAULT_FROM_EMAIL='test@example.com' \
            -e CELERY_BROKER_URL='memory://' \
            -e CELERY_RESULT_BACKEND='cache+memory://' \
            -e DB_ENGINE='django.db.backends.sqlite3' \
            -e POSTGRES_HOST='localhost' \
            -e POSTGRES_DB='test_db' \
            -e POSTGRES_USER='test_user' \
            -e POSTGRES_PASSWORD='test_password' \
            -e POSTGRES_PORT=5432 \
            -e S3_BUCKET_NAME='test-bucket' \
            -e AWS_ACCESS_KEY_ID='test-key-id' \
            -e AWS_SECRET_ACCESS_KEY='test-secret-key' \
            -e AWS_DEFAULT_REGION='us-east-1' \
            -e GEMINI_API_KEY='test-gemini-api-key-for-ci' \
            -e NEXT_PUBLIC_BACKEND_URL='http://localhost:8080/' \
            -e NEXT_PUBLIC_HMIS_VERSION='v0.0.1-test' \
            backend-test:ci sh -c "python manage.py check && pytest -v"


  build-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Docker Login
        run: echo $DOCKER_TOKEN | docker login -u $DOCKER_USER --password-stdin
      - name: Build & Push Backend Image
        run: |
          cd backend
          docker build . -t mosesmbadi/easymedbackend:latest
          docker push mosesmbadi/easymedbackend:latest

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Docker Login
        run: echo $DOCKER_TOKEN | docker login -u $DOCKER_USER --password-stdin
      - name: Build & Push Frontend Image
        run: |
          cd front-end
          docker build \
            --build-arg NEXT_PUBLIC_BACKEND_URL="http://api:8080/" \
            --build-arg NEXT_PUBLIC_HMIS_VERSION="v0.0.1-alpha-0.1" \
            -t mosesmbadi/easymedfrontend:latest .
          docker push mosesmbadi/easymedfrontend:latest